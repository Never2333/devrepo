name: Build APT Repo (Zebra)

on:
  push:
    branches: [ "main" ]
    paths:
      - "debs/**"
      - ".github/workflows/apt-repo.yml"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            dpkg-dev apt-utils gzip xz-utils zstd bzip2

      - name: Build repo index
        run: |
          set -euo pipefail
          mkdir -p public/debs
          shopt -s nullglob
          debs=(debs/*.deb)
          if [ "${#debs[@]}" -eq 0 ]; then
            echo "No .deb found in ./debs. Upload your .deb(s) to the debs/ folder first."
            exit 1
          fi
          cp -f debs/*.deb public/debs/
          cd public
          dpkg-scanpackages -m debs /dev/null > Packages
          gzip -9c Packages > Packages.gz
          bzip2 -9c Packages > Packages.bz2
          xz -9c Packages > Packages.xz
          zstd -q -19 -c Packages > Packages.zst
          {
            echo "Origin: CShop Devkit";
            echo "Label: CShop Devkit";
            echo "Description: CShop Devkit APT repo (GitHub Pages).";
            apt-ftparchive release .;
          } > Release

      - name: Publish to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: public
          publish_branch: gh-pages
          force_orphan: true
